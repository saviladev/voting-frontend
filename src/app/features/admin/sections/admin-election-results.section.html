<div class="grid">
  <div class="card span-12" *ngIf="election()">
    <!-- Header -->
    <div class="card-header">
      <div>
        <h3>{{ election()!.name }}</h3>
        <p>
          {{ getScopeLabel(election()!.scope) }} • {{ getStatusLabel(election()!.status) }}
          <span *ngIf="election()!.association"> • {{ election()!.association!.name }}</span>
          <span *ngIf="election()!.branch"> / {{ election()!.branch!.name }}</span>
          <span *ngIf="election()!.chapter"> / {{ election()!.chapter!.name }}</span>
        </p>
      </div>
      <div class="filter-row">
        <button
          type="button"
          class="btn primary"
          (click)="exportToPDF()"
          [disabled]="!canViewResults || !results()"
        >
          Exportar a PDF
        </button>
        <a [routerLink]="['/admin/elections', election()!.id]" class="btn ghost">
          Volver a Detalles
        </a>
      </div>
    </div>

    <!-- Results Display Mode -->
    <div class="card-body">
      <!-- Warning if not completed -->
      <div *ngIf="!canViewResults" style="padding: 1rem; background: var(--ion-color-warning-tint); border: 1px solid var(--ion-color-warning); border-radius: 6px; margin-bottom: 1rem;">
        <strong>Resultados no disponibles.</strong>
        Los resultados solo están disponibles cuando la elección está en estado COMPLETADA.
      </div>

      <!-- Results tabs (only if completed) -->
      <div *ngIf="canViewResults && results()">
        <!-- Tab Navigation -->
        <div class="results-tabs">
          <button
            type="button"
            class="btn ghost"
            [class.active]="activeTab() === 'overview'"
            (click)="setActiveTab('overview')"
            style="border-bottom: 3px solid transparent;"
            [style.border-bottom-color]="activeTab() === 'overview' ? 'var(--primary)' : 'transparent'"
          >
            Resumen
          </button>
          <button
            type="button"
            class="btn ghost"
            [class.active]="activeTab() === 'by-position'"
            (click)="setActiveTab('by-position')"
            style="border-bottom: 3px solid transparent;"
            [style.border-bottom-color]="activeTab() === 'by-position' ? 'var(--primary)' : 'transparent'"
          >
            Por Cargo
          </button>
          <button
            type="button"
            class="btn ghost"
            [class.active]="activeTab() === 'by-list'"
            (click)="setActiveTab('by-list')"
            style="border-bottom: 3px solid transparent;"
            [style.border-bottom-color]="activeTab() === 'by-list' ? 'var(--primary)' : 'transparent'"
          >
            Por Lista
          </button>
          <button
            type="button"
            class="btn ghost"
            [class.active]="activeTab() === 'detailed'"
            (click)="setActiveTab('detailed')"
            style="border-bottom: 3px solid transparent;"
            [style.border-bottom-color]="activeTab() === 'detailed' ? 'var(--primary)' : 'transparent'"
          >
            Detallado
          </button>
        </div>

        <!-- Overview Tab -->
        <div *ngIf="activeTab() === 'overview'">
          <div class="grid">
            <!-- Statistics Cards -->
            <div class="card span-4">
              <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);">{{ results()!.totalVotes }}</div>
                <div class="text-muted">Total de Votos</div>
              </div>
            </div>
            <div class="card span-4">
              <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);">{{ results()!.listResults.length }}</div>
                <div class="text-muted">Listas Participantes</div>
              </div>
            </div>
            <div class="card span-4">
              <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);">{{ results()!.positionResults.length }}</div>
                <div class="text-muted">Cargos en Disputa</div>
              </div>
            </div>

            <!-- Pie Chart Section -->
            <div class="card span-12">
              <div class="card-header">
                <h4 style="margin: 0;">Distribución de Votos por Lista</h4>
              </div>
              <div class="card-body">
                <div class="chart-container-mobile" style="display: flex; gap: 2rem; align-items: center;">
                  <!-- Legend -->
                  <div style="flex: 1;">
                    <div *ngFor="let list of results()!.listResults" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      <div style="width: 16px; height: 16px; border-radius: 4px;" [style.background]="getColorByListId(list.listId)"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.95rem;">{{ list.listName }}</div>
                        <small class="text-muted" *ngIf="list.listNumber || list.partyName" style="font-size: 0.8rem;">
                          <span *ngIf="list.listNumber">N° {{ list.listNumber }}</span>
                          <span *ngIf="list.partyName"> • {{ list.partyName }}</span>
                        </small>
                      </div>
                      <div style="font-weight: 700; color: var(--admin-primary);">{{ list.percentage.toFixed(1) }}%</div>
                    </div>
                  </div>
                  
                  <!-- Canvas chart -->
                  <div class="chart-canvas-wrapper" style="width: 300px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <canvas #pieChart width="300" height="300" style="display: block;"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Winners by Position -->
            <div class="card span-12">
              <div class="card-header">
                <h4 style="margin: 0;">Ganadores por Cargo</h4>
              </div>
              <div class="card-body">
                <div class="grid">
                  <div class="card span-6" *ngFor="let position of results()!.positionResults">
                    <div class="card-header">
                      <h5 style="margin: 0;">{{ position.positionTitle }}</h5>
                    </div>
                    <div class="card-body">
                      <div *ngIf="getWinnerByPosition(position.positionId) as winner" style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 4px; height: 60px; border-radius: 2px;" [style.background]="getColorByListId(winner.listId)"></div>
                        <div style="flex: 1;">
                          <div style="font-size: 1.25rem; font-weight: 500;">{{ winner.candidateName }}</div>
                          <div class="text-muted">{{ winner.listName }}</div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">{{ winner.voteCount }}</div>
                          <div class="text-muted">{{ winner.percentage.toFixed(2) }}%</div>
                        </div>
                      </div>
                      <div *ngIf="!getWinnerByPosition(position.positionId)" class="text-muted" style="font-style: italic;">
                        Sin votos registrados
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- By Position Tab -->
        <div *ngIf="activeTab() === 'by-position'">
          <div class="card" *ngFor="let position of results()!.positionResults" style="margin-bottom: 1rem;">
            <div class="card-header">
              <h4 style="margin: 0;">{{ position.positionTitle }}</h4>
            </div>
            <div class="card-body">
              <table class="table desktop-only">
                <thead>
                  <tr>
                    <th>Candidato</th>
                    <th>Lista</th>
                    <th>Votos</th>
                    <th>Porcentaje</th>
                    <th style="width: 200px;">Distribución</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let candidate of position.candidates; let i = index">
                    <td>{{ candidate.candidateName }}</td>
                    <td>{{ candidate.listName }}</td>
                    <td>{{ candidate.voteCount }}</td>
                    <td>{{ candidate.percentage.toFixed(2) }}%</td>
                    <td>
                      <div style="background: #f0f0f0; height: 24px; border-radius: 4px; overflow: hidden;">
                        <div [style.background]="getColorByListId(candidate.listId)" style="height: 100%; transition: width 0.3s ease;" [style.width.%]="candidate.percentage"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Mobile Results Cards -->
              <div class="mobile-only result-cards">
                <div *ngFor="let candidate of position.candidates" class="mobile-card">
                   <div class="card-mobile-header">
                      <div class="mobile-title-status">
                         <div class="mobile-title">{{ candidate.candidateName }}</div>
                         <div style="font-weight: 700; color: var(--admin-primary);">{{ candidate.voteCount }} v.</div>
                      </div>
                      <div class="mobile-subtitle">{{ candidate.listName }}</div>
                   </div>
                   <div class="card-mobile-body">
                      <div class="mobile-info-row">
                         <strong>Porcentaje:</strong> {{ candidate.percentage.toFixed(2) }}%
                      </div>
                      <div class="progress-bar-container">
                         <div class="progress-bar" [style.background]="getColorByListId(candidate.listId)" [style.width.%]="candidate.percentage"></div>
                      </div>
                   </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- By List Tab -->
        <div *ngIf="activeTab() === 'by-list'">
          <div class="card" *ngFor="let list of results()!.listResults; let i = index" style="margin-bottom: 1rem;">
            <div class="card-header">
              <div>
                <h4 style="margin: 0;">{{ list.listName }}</h4>
                <small class="text-muted">
                  <span *ngIf="list.listNumber">N° {{ list.listNumber }}</span>
                  <span *ngIf="list.partyName"> • {{ list.partyName }}</span>
                </small>
              </div>
            </div>
            <div class="card-body">
              <div style="display: flex; gap: 2rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <div>
                  <div class="text-muted" style="font-size: 0.85rem;">Total de Votos</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--admin-primary);">{{ list.totalVotes }}</div>
                </div>
                <div>
                  <div class="text-muted" style="font-size: 0.85rem;">Porcentaje</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--admin-primary);">{{ list.percentage.toFixed(2) }}%</div>
                </div>
              </div>
              <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
                <div [style.background]="getColorByListId(list.listId)" style="height: 100%; transition: width 0.3s ease;" [style.width.%]="list.percentage"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Tab -->
        <div *ngIf="activeTab() === 'detailed'">
          <table class="table desktop-only">
            <thead>
              <tr>
                <th>Candidato</th>
                <th>Cargo</th>
                <th>Lista</th>
                <th>Partido</th>
                <th>Votos</th>
                <th>Porcentaje</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let candidate of results()!.candidateResults">
                <td>{{ candidate.candidateName }}</td>
                <td>{{ candidate.positionTitle }}</td>
                <td>{{ candidate.listName }}</td>
                <td>{{ candidate.partyName || '-' }}</td>
                <td>{{ candidate.voteCount }}</td>
                <td>{{ candidate.percentage.toFixed(2) }}%</td>
              </tr>
            </tbody>
          </table>

          <!-- Mobile Detailed Cards -->
          <div class="mobile-only detailed-cards">
             <div *ngFor="let candidate of results()!.candidateResults" class="mobile-card">
                 <div class="card-mobile-header">
                    <div class="mobile-title-status">
                       <div class="mobile-title">{{ candidate.candidateName }}</div>
                       <div style="font-weight: 700; color: var(--admin-primary);">{{ candidate.voteCount }} v.</div>
                    </div>
                    <div class="mobile-subtitle">{{ candidate.positionTitle }}</div>
                 </div>
                 <div class="card-mobile-body">
                    <div class="mobile-info-row">
                       <strong>Lista:</strong> {{ candidate.listName }}
                    </div>
                    <div class="mobile-info-row">
                       <strong>Porcentaje:</strong> {{ candidate.percentage.toFixed(2) }}%
                    </div>
                 </div>
             </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
